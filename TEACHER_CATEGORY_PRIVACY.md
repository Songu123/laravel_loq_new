# Teacher Category Privacy - Ch·ªâ Xem Danh M·ª•c C·ªßa M√¨nh

## üìã T·ªïng quan
ƒê√£ c·∫≠p nh·∫≠t h·ªá th·ªëng qu·∫£n l√Ω danh m·ª•c ƒë·ªÉ teacher **ch·ªâ c√≥ th·ªÉ xem v√† qu·∫£n l√Ω danh m·ª•c do ch√≠nh m√¨nh t·∫°o ra**.

## ‚úÖ C√°c thay ƒë·ªïi ƒë√£ th·ª±c hi·ªán

### 1. **CategoryController** - L·ªçc theo Teacher
**File**: `app/Http/Controllers/Teacher/CategoryController.php`

#### A. Constructor v·ªõi Authorization
```php
public function __construct()
{
    $this->authorizeResource(Category::class, 'category');
}
```
- ‚úÖ T·ª± ƒë·ªông √°p d·ª•ng CategoryPolicy cho t·∫•t c·∫£ CRUD operations
- ‚úÖ Ki·ªÉm tra quy·ªÅn truy c·∫≠p tr∆∞·ªõc khi th·ª±c thi action

#### B. Index - Ch·ªâ danh m·ª•c c·ªßa m√¨nh
```php
public function index()
{
    $categories = Category::where('created_by', Auth::id())
        ->with('creator')
        ->orderBy('sort_order')
        ->orderBy('name')
        ->paginate(12);
}
```

**Tr∆∞·ªõc:**
```php
// Teachers can see all active categories (including their own)
$categories = Category::active()->with('creator')->paginate(12);
```

**Sau:**
```php
// Teachers can only see their own categories
$categories = Category::where('created_by', Auth::id())->paginate(12);
```

#### C. Show - Ki·ªÉm tra quy·ªÅn truy c·∫≠p
```php
public function show(Category $category)
{
    // Authorization handled by CategoryPolicy
    return view('teacher.categories.show', compact('category'));
}
```

**Tr∆∞·ªõc:** Manual check v·ªõi `abort(403)` n·∫øu kh√¥ng ph·∫£i creator
**Sau:** Policy t·ª± ƒë·ªông ki·ªÉm tra, n√©m `AuthorizationException` n·∫øu kh√¥ng c√≥ quy·ªÅn

#### D. Update & Delete - Simplified
```php
public function update(UpdateCategoryRequest $request, Category $category)
{
    // Authorization handled by CategoryPolicy
    $validated = $request->validated();
    // ... update logic
}

public function destroy(Category $category)
{
    // Authorization handled by CategoryPolicy
    $category->delete();
}
```

**Lo·∫°i b·ªè:**
- ‚ùå Manual authorization checks
- ‚ùå Duplicate code
- ‚ùå Hard-coded error messages

**Th√™m v√†o:**
- ‚úÖ Policy-based authorization
- ‚úÖ Consistent error handling
- ‚úÖ DRY principle

#### E. getCategories - API endpoint
```php
public function getCategories(Request $request)
{
    $categories = Category::where('created_by', Auth::id())
        ->orderBy('sort_order')
        ->orderBy('name')
        ->get(['id', 'name', 'color', 'icon', 'is_active']);
}
```

**Tr∆∞·ªõc:** Tr·∫£ v·ªÅ t·∫•t c·∫£ active categories
**Sau:** Ch·ªâ tr·∫£ v·ªÅ categories c·ªßa teacher ƒëang login

---

### 2. **CategoryPolicy** - Updated View Permission
**File**: `app/Policies/CategoryPolicy.php`

```php
public function view(User $user, Category $category): bool
{
    // Admin can view all
    if ($user->isAdmin()) {
        return true;
    }

    // Teachers can only view their own categories
    if ($user->isTeacher()) {
        return $category->created_by === $user->id;
    }

    // Students can view active categories
    return $category->is_active;
}
```

**Logic m·ªõi:**
- üîë **Admin**: Xem t·∫•t c·∫£ categories
- üë®‚Äçüè´ **Teacher**: Ch·ªâ xem categories c·ªßa m√¨nh (`created_by` === `user_id`)
- üë®‚Äçüéì **Student**: Xem active categories (for exams)

**Tr∆∞·ªõc:**
```php
// Active categories are visible to everyone
if ($category->is_active) {
    return true;
}
```

**Sau:**
```php
// Teachers can only view their own categories
if ($user->isTeacher()) {
    return $category->created_by === $user->id;
}
```

---

### 3. **DashboardController** - Own Categories Only
**File**: `app/Http/Controllers/Teacher/DashboardController.php`

```php
$categories = Category::where('created_by', $userId)
    ->withCount([...])
    ->with([...])
    ->orderBy('sort_order')
    ->get()
    ->map(function($category) { ... });
```

**Tr∆∞·ªõc:**
```php
Category::where('created_by', $userId)
    ->orWhere('is_active', true) // Include active global categories
    ->having('teacher_exams_count', '>', 0)
```

**Sau:**
```php
Category::where('created_by', $userId) // Only own categories
```

**Lo·∫°i b·ªè:**
- ‚ùå `orWhere('is_active', true)` - Kh√¥ng hi·ªÉn th·ªã global categories
- ‚ùå `having('teacher_exams_count', '>', 0)` - Hi·ªÉn th·ªã c·∫£ categories r·ªóng

---

### 4. **View Templates** - UI Cleanup
**File**: `resources/views/teacher/categories/index.blade.php`

#### A. Header Update
```blade
<h1 class="h3 mb-0 text-gray-800">Danh m·ª•c m√¥n h·ªçc c·ªßa t√¥i</h1>
<p class="text-muted">Qu·∫£n l√Ω c√°c danh m·ª•c cho ƒë·ªÅ thi v√† c√¢u h·ªèi c·ªßa b·∫°n</p>
```

**Tr∆∞·ªõc:** "Danh m·ª•c m√¥n h·ªçc"
**Sau:** "Danh m·ª•c m√¥n h·ªçc c·ªßa t√¥i"

#### B. Simplified Actions (Grid View)
```blade
<div class="d-flex gap-1 justify-content-center">
    <a href="{{ route('teacher.categories.show', $category) }}" class="btn btn-sm btn-outline-primary">
        <i class="bi bi-eye"></i> Xem
    </a>
    <a href="{{ route('teacher.categories.edit', $category) }}" class="btn btn-sm btn-outline-warning">
        <i class="bi bi-pencil"></i> S·ª≠a
    </a>
    <button class="btn btn-sm btn-outline-danger delete-btn">
        <i class="bi bi-trash"></i> X√≥a
    </button>
</div>
```

**Lo·∫°i b·ªè:**
```blade
@if($category->created_by === Auth::id())
    <!-- Edit/Delete buttons -->
@else
    <button onclick="createExamWithCategory({{ $category->id }})">
        <i class="bi bi-plus"></i> T·∫°o ƒë·ªÅ thi
    </button>
@endif

<div class="mt-2">
    @if($category->created_by === Auth::id())
        <span class="badge bg-info">C·ªßa t√¥i</span>
    @endif
</div>
```

**L√Ω do:**
- T·∫•t c·∫£ categories ƒë·ªÅu l√† c·ªßa teacher
- Kh√¥ng c·∫ßn ki·ªÉm tra `created_by === Auth::id()`
- Kh√¥ng c·∫ßn badge "C·ªßa t√¥i"
- Kh√¥ng c√≥ option "T·∫°o ƒë·ªÅ thi" t·ª´ categories c·ªßa ng∆∞·ªùi kh√°c

#### C. Simplified List View
```blade
<td>
    <div class="d-flex align-items-center">
        @if($category->icon)
            <i class="{{ $category->icon }} me-2"></i>
        @endif
        <div>
            <div class="fw-semibold">{{ $category->name }}</div>
            <div class="text-muted small">Th·ª© t·ª±: {{ $category->sort_order }}</div>
        </div>
    </div>
</td>
<td>
    <div class="btn-group btn-group-sm">
        <a href="{{ route('teacher.categories.show', $category) }}" class="btn btn-outline-info">
            <i class="bi bi-eye"></i>
        </a>
        <a href="{{ route('teacher.categories.edit', $category) }}" class="btn btn-outline-warning">
            <i class="bi bi-pencil"></i>
        </a>
        <button class="btn btn-outline-danger delete-btn">
            <i class="bi bi-trash"></i>
        </button>
    </div>
</td>
```

**Lo·∫°i b·ªè:**
- ‚ùå Badge "C·ªßa t√¥i" trong list view
- ‚ùå Conditional buttons based on ownership
- ‚ùå "T·∫°o ƒë·ªÅ thi" button cho categories kh√°c

---

## üîí Security & Authorization Flow

### Request Flow v·ªõi Policy:

```
1. Teacher Request: GET /teacher/categories/{category}
   ‚Üì
2. Route Model Binding loads Category
   ‚Üì
3. CategoryController constructor: $this->authorizeResource()
   ‚Üì
4. Laravel calls CategoryPolicy::view($user, $category)
   ‚Üì
5. Policy checks:
   - Is Admin? ‚Üí Allow
   - Is Teacher AND created_by === user_id? ‚Üí Allow
   - Otherwise ‚Üí Deny (403 Forbidden)
   ‚Üì
6. If allowed: show($category) executes
   If denied: AuthorizationException thrown
```

### Authorization Methods:

| Action | Policy Method | Check |
|--------|--------------|-------|
| Index | viewAny | Always allowed for authenticated users |
| Show | view | Admin OR (Teacher AND owner) |
| Create | create | Teacher OR Admin |
| Edit | update | Admin OR (Teacher AND owner) |
| Update | update | Admin OR (Teacher AND owner) |
| Delete | delete | Admin OR (Teacher AND owner AND no exams) |

---

## üìä Database Queries

### Before (All Active Categories):
```sql
SELECT * FROM categories 
WHERE is_active = 1 
ORDER BY sort_order, name;
-- Returns: All active categories (global + personal)
```

### After (Own Categories Only):
```sql
SELECT * FROM categories 
WHERE created_by = {teacher_id}
ORDER BY sort_order, name;
-- Returns: Only categories created by this teacher
```

**Performance Impact:**
- ‚úÖ Faster queries (smaller result set)
- ‚úÖ Better index usage (`created_by` is indexed)
- ‚úÖ Reduced memory usage

---

## üéØ Use Cases

### 1. Teacher A t·∫°o category "To√°n h·ªçc"
```php
Category::create([
    'name' => 'To√°n h·ªçc',
    'created_by' => 1, // Teacher A's ID
    'is_active' => true,
]);
```

**K·∫øt qu·∫£:**
- ‚úÖ Teacher A th·∫•y "To√°n h·ªçc" trong danh s√°ch
- ‚ùå Teacher B KH√îNG th·∫•y "To√°n h·ªçc"
- ‚ùå Teacher C KH√îNG th·∫•y "To√°n h·ªçc"

### 2. Teacher B c·ªë truy c·∫≠p category c·ªßa Teacher A
```
GET /teacher/categories/1
```

**Response:**
```
403 Forbidden
"This action is unauthorized."
```

**Policy Logic:**
```php
public function view(User $user, Category $category): bool
{
    if ($user->isTeacher()) {
        return $category->created_by === $user->id; // false ‚Üí denied
    }
}
```

### 3. Admin xem t·∫•t c·∫£ categories
```
GET /admin/categories
```

**Response:**
```
200 OK
[
    { id: 1, name: "To√°n h·ªçc", created_by: 1 },
    { id: 2, name: "V·∫≠t l√Ω", created_by: 2 },
    { id: 3, name: "H√≥a h·ªçc", created_by: 1 },
]
```

**Policy Logic:**
```php
public function view(User $user, Category $category): bool
{
    if ($user->isAdmin()) {
        return true; // Always allowed
    }
}
```

---

## üîç Testing Scenarios

### Test 1: Teacher ch·ªâ th·∫•y danh m·ª•c c·ªßa m√¨nh
```php
// Given
$teacher1 = User::factory()->teacher()->create();
$teacher2 = User::factory()->teacher()->create();

Category::create(['name' => 'Math', 'created_by' => $teacher1->id]);
Category::create(['name' => 'Physics', 'created_by' => $teacher2->id]);

// When
$this->actingAs($teacher1)->get('/teacher/categories');

// Then
$response->assertSee('Math');
$response->assertDontSee('Physics');
```

### Test 2: Kh√¥ng th·ªÉ xem category c·ªßa ng∆∞·ªùi kh√°c
```php
// Given
$category = Category::create(['created_by' => $teacher2->id]);

// When
$this->actingAs($teacher1)->get("/teacher/categories/{$category->id}");

// Then
$response->assertStatus(403);
```

### Test 3: Kh√¥ng th·ªÉ edit category c·ªßa ng∆∞·ªùi kh√°c
```php
// Given
$category = Category::create(['created_by' => $teacher2->id]);

// When
$this->actingAs($teacher1)->put("/teacher/categories/{$category->id}", [
    'name' => 'Hacked',
]);

// Then
$response->assertStatus(403);
$category->refresh();
$this->assertNotEquals('Hacked', $category->name);
```

### Test 4: Admin c√≥ th·ªÉ xem t·∫•t c·∫£
```php
// Given
$admin = User::factory()->admin()->create();
$category = Category::create(['created_by' => $teacher1->id]);

// When
$this->actingAs($admin)->get("/teacher/categories/{$category->id}");

// Then
$response->assertStatus(200);
```

---

## üìù Summary of Changes

### Files Modified:
1. ‚úÖ `app/Http/Controllers/Teacher/CategoryController.php`
   - Added `authorizeResource()` in constructor
   - Removed manual authorization checks
   - Updated queries to filter by `created_by`
   
2. ‚úÖ `app/Policies/CategoryPolicy.php`
   - Updated `view()` method for teacher privacy
   
3. ‚úÖ `app/Http/Controllers/Teacher/DashboardController.php`
   - Removed global category inclusion
   
4. ‚úÖ `resources/views/teacher/categories/index.blade.php`
   - Updated header text
   - Removed ownership checks
   - Simplified action buttons

### Benefits:
- üîí **Privacy**: Teachers can't see other teachers' categories
- üéØ **Focus**: Dashboard only shows relevant categories
- üöÄ **Performance**: Smaller queries, better indexing
- üßπ **Clean Code**: Policy-based authorization, no duplicate checks
- üì± **Consistency**: Same authorization logic across all actions

---

## üöÄ Migration Guide

### For Existing Teachers:
1. Login to teacher dashboard
2. Navigate to "Danh m·ª•c m√¥n h·ªçc"
3. You will now ONLY see categories you created
4. Global categories created by admin are no longer visible

### For Admins:
- No changes needed
- Admin dashboard still shows all categories
- Can manage all categories regardless of creator

### For Students:
- No impact
- Students still see active categories when taking exams
- Category visibility for exams unchanged

---

**Status**: ‚úÖ Complete and Tested
**Date**: 2025-01-25
**Security Level**: Enhanced
**Privacy**: Teacher-scoped categories
